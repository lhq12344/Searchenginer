<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Search</title>
  <style>
    :root {
      --bg: #1e1b16;
      --card: #3a3126;
      --card-2: #2d261e;
      --text: #f2f2f2;
      --muted: #cfc7bb;
      --accent: #56b6f7;
      --accent-2: #8ad6ff;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 22px;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: linear-gradient(180deg, #b78f58 0%, #c7a373 40%, #d7b78f 100%);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      width: min(920px, 92vw);
      background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
      border-radius: var(--radius);
      padding: 28px 28px 18px;
      box-shadow: var(--shadow);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      opacity: .9;
    }
    .brand svg { width: 28px; height: 28px; }
    .brand .name { font-weight: 600; letter-spacing: .5px; color: var(--muted); }

    .searchbar {
      position: relative;
      background: #3b3026;
      border-radius: 28px;
      padding: 12px 16px 12px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .searchbar:focus-within { box-shadow: inset 0 0 0 2px rgba(255,255,255,.12); }
    .logo {
      width: 36px; height: 36px; border-radius: 12px;
      background: #ffffff10; display: grid; place-items: center;
      flex: 0 0 auto;
    }
    .logo svg { width: 22px; height: 22px; }
    .input {
      flex: 1; min-width: 120px;
      background: transparent; border: none; outline: none;
      color: var(--text);
      font-size: 18px; caret-color: var(--accent);
    }
    .btn { cursor: pointer; border: none; outline: none; border-radius: 12px; padding: 10px 14px; color: #1b1b1b; background: var(--accent); font-weight: 600; }
    .btn:hover { background: var(--accent-2); }

    /* suggestions */
    .suggest-box {
      position: absolute; left: 0; right: 0; top: calc(100% + 8px);
      background: #342b22; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow);
      display: none; /* toggled via JS */
      max-height: 300px; overflow-y: auto;
      border: 1px solid rgba(255,255,255,.08);
      z-index: 20;
    }
    .sug-item { padding: 10px 14px; color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .sug-item:hover, .sug-item.active { background: #413629; }
    .sug-item .badge { font-size: 12px; color: var(--muted); margin-left: auto; }

    /* results */
    .result { padding: 14px 10px; border-bottom: 1px solid rgba(255,255,255,.06); }
    .result a.title { color: var(--accent-2); font-weight: 600; text-decoration: none; font-size: 18px; }
    .result a.title:hover { text-decoration: underline; }
    .result .meta { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .result .snippet { color: #eee; margin-top: 6px; line-height: 1.5; }

    .footer { color: var(--muted); font-size: 12px; margin-top: 14px; text-align: right; }
    .row { display: flex; gap: 10px; margin-top: 10px; }
    .row .btn.secondary { background: transparent; color: var(--text); border: 1px solid rgba(255,255,255,.2); }
    .row .btn.secondary:hover { background: #4a3d30; }
  </style>
</head>
<body>
  <div class="card">
    <div class="brand" aria-label="Logo">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="2" y="2" width="20" height="20" rx="5" fill="#5AB1F6"/>
        <path d="M7 12h10" stroke="#0b3751" stroke-width="2.2" stroke-linecap="round"/>
        <path d="M12 7v10" stroke="#0b3751" stroke-width="2.2" stroke-linecap="round"/>
      </svg>
      <div class="name">Mini Search</div>
    </div>

    <div class="searchbar" role="search">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="11" r="6.5" stroke="#cdeaff" stroke-width="2"/>
          <path d="M15.5 15.5L21 21" stroke="#cdeaff" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <input id="q" class="input" placeholder="输入搜索内容" autocomplete="off" />
      <button id="btnSearch" class="btn">搜索</button>
      
      <div id="sugBox" class="suggest-box" role="listbox" aria-label="关键词推荐"></div>
    </div>

    <div class="row">
      <button id="btnLucky" class="btn secondary">手气不错</button>
      <button id="btnClear" class="btn secondary">清空</button>
    </div>

    <div id="results" style="margin-top:16px;"></div>
    <div class="footer">API: /api/suggest 与 /api/search · 同源调用</div>
  </div>

  <script>
    // ========== API 规范（前端约定） ==========
  // 1) 关键词推荐: POST /api/suggest (application/x-www-form-urlencoded)
  //    请求 body: searchword=<string>&n=<int>
  //    响应: { code: 0, msg: "ok", data: { query: string, suggestions: [ { word: string, freq?: number, score?: number } ] } }
    // 2) 网页查询:   GET /api/search?q=<string>&page=<int>&size=<int>
    //    响应: { code: 0, msg: "ok", data: { query: string, total: number, page: number, size: number, items: [ { title: string, url: string, snippet: string, score?: number } ] } }
    // 失败统一: { code: 非0, msg: 错误信息 }

    const API = {
      suggest: () => `/api/suggest`,
      search:  (q, page = 1, size = 10) => `/api/search?q=${encodeURIComponent(q)}&page=${page}&size=${size}`
    };

    const els = {
      q: document.getElementById('q'),
      sugBox: document.getElementById('sugBox'),
      results: document.getElementById('results'),
      btnSearch: document.getElementById('btnSearch'),
      btnLucky: document.getElementById('btnLucky'),
      btnClear: document.getElementById('btnClear'),
    };

  let sugIndex = -1; // keyboard focus
  let suggestions = [];
  let debounceTimer = 0;
  // 标记是否处于 IME 合成（输入法拼写）阶段
  let isComposing = false;

    function showSuggestions(list){
      suggestions = list || [];
      const has = suggestions.length > 0;
      els.sugBox.style.display = has ? 'block' : 'none';
      if(!has){ els.sugBox.innerHTML = ''; return; }
      els.sugBox.innerHTML = suggestions.map((s, i)=>`
        <div class="sug-item" role="option" data-index="${i}">
          <span>${escapeHtml(s.word || s)}</span>
          ${s.score!=null ? `<span class=badge>score ${Math.round(s.score*100)/100}</span>` : (s.freq!=null? `<span class=badge>freq ${s.freq}</span>` : '')}
        </div>`).join('');
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"]+/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s]));
    }

    async function fetchSuggest(q, n = 8){
      // Accept both server response shapes:
      // 1) { code:0, backwords: ["a","b"] }
      // 2) { code:0, data: { suggestions: [ { word:..., score... }, ... ] } }
      if(!q.trim()){ showSuggestions([]); return; }
      try{
        const body = new URLSearchParams();
        body.append('searchword', q);
        body.append('n', String(n));
        const r = await fetch(API.suggest(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        });
        const j = await r.json();
        if(!j || j.code !== 0){ showSuggestions([]); return; }

        // prefer top-level backwords (srpc server currently returns this)
        if(Array.isArray(j.backwords)){
          // normalize strings into objects for rendering convenience
          showSuggestions(j.backwords.map(s => (typeof s === 'string' ? s : s)));
          return;
        }

        if(j.data && Array.isArray(j.data.suggestions)){
          showSuggestions(j.data.suggestions);
          return;
        }

        showSuggestions([]);
      }catch(e){ showSuggestions([]); }
    }

    async function doSearch(q){
      if(!q.trim()) return;
      els.sugBox.style.display = 'none';
      els.results.innerHTML = '<div class="result">正在搜索…</div>';
      try{
        // Submit as POST form to match server which expects application/x-www-form-urlencoded
        const body = new URLSearchParams();
        body.append('searchstring', q);
        const r = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        });
        const j = await r.json();

        // 支持两种后端响应形态：
        // 1) { code:0, data: { items: [ { title, url, snippet }, ... ], total } }
        // 2) { code:0, items: [ { title, link, description }, ... ] }
        let items = [];
        let total = 0;
        if(j && j.code === 0){
          if(j.data && Array.isArray(j.data.items)){
            items = j.data.items;
            total = j.data.total || items.length;
          }else if(Array.isArray(j.items)){
            items = j.items;
            total = items.length;
          }
        }else{
          throw new Error(j && j.msg || '搜索失败');
        }

        if(items.length===0){
          els.results.innerHTML = `<div class="result">未找到与“${escapeHtml(q)}”相关的结果。</div>`;
          return;
        }

        els.results.innerHTML = items.map(item=>{
          const title = item.title || item.url || item.link || '';
          const href = item.link || item.url || '#';
          const desc = item.description || item.snippet || '';
          const preview = truncateByChars(desc, 100);
          return `
            <div class="result">
              <a class="title" href="${escapeHtml(href)}" target="_blank" rel="noreferrer">${escapeHtml(title)}</a>
              <div class="meta">${escapeHtml(href)}</div>
              <div class="snippet">${escapeHtml(preview)}</div>
            </div>`;
        }).join('') + `<div class="footer">共 ${total} 条结果</div>`;

      }catch(e){
        els.results.innerHTML = `<div class="result">错误：${escapeHtml(e.message||String(e))}</div>`;
      }
    }

    // events
    // 在输入法合成期间不要触发建议请求（会发送不完整拼音）
    els.q.addEventListener('compositionstart', () => {
      isComposing = true;
    });

    els.q.addEventListener('compositionend', (e) => {
      // 合成结束，标记结束并立即请求一次建议（合成后的字符已提交）
      isComposing = false;
      // 有些浏览器在 compositionend 后会跟一个 input 事件，但为了确保立刻响应我们主动触发
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=> fetchSuggest(els.q.value), 0);
    });

    els.q.addEventListener('input', () => {
      // 如果正在合成（按拼音还没选字），不要触发远程建议
      if (isComposing) return;
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=> fetchSuggest(els.q.value), 160);
    });

    els.q.addEventListener('keydown', (e)=>{
      const max = suggestions.length - 1;
      if(e.key === 'ArrowDown'){
        sugIndex = Math.min(max, sugIndex+1); updateActive(); e.preventDefault();
      } else if(e.key === 'ArrowUp'){
        sugIndex = Math.max(-1, sugIndex-1); updateActive(); e.preventDefault();
      } else if(e.key === 'Enter'){
        // 如果正在合成（输入法），忽略回车的搜索触发，等待 compositionend
        if (isComposing) return;
        if(sugIndex>=0 && suggestions[sugIndex]){
          els.q.value = suggestions[sugIndex].word || suggestions[sugIndex];
        }
        doSearch(els.q.value);
      } else if(e.key === 'Escape'){
        els.sugBox.style.display = 'none';
      }
    });

    function updateActive(){
      const nodes = els.sugBox.querySelectorAll('.sug-item');
      nodes.forEach(n=>n.classList.remove('active'));
      if(sugIndex>=0 && nodes[sugIndex]){
        nodes[sugIndex].classList.add('active');
        nodes[sugIndex].scrollIntoView({ block: 'nearest' });
      }
    }

    els.sugBox.addEventListener('click', (e)=>{
      const item = e.target.closest('.sug-item');
      if(!item) return;
      const i = +item.dataset.index;
      if(Number.isInteger(i) && suggestions[i]){
        els.q.value = suggestions[i].word || suggestions[i];
        doSearch(els.q.value);
      }
    });

    els.btnSearch.addEventListener('click', ()=> doSearch(els.q.value));
    els.btnLucky.addEventListener('click', async ()=>{
      // Lucky: 取第一个推荐直接搜索
      if(!els.q.value.trim()) return;
      try{
        // 请求 top-1 推荐，使用 POST 与后端约定一致
        const body = new URLSearchParams();
        body.append('searchword', els.q.value);
        body.append('n', '1');
        const r = await fetch(API.suggest(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        });
        const j = await r.json();
        const first = j && j.data && j.data.suggestions && j.data.suggestions[0];
        const q = (first && (first.word || first)) || els.q.value;
        doSearch(q);
      }catch{ doSearch(els.q.value); }
    });
    els.btnClear.addEventListener('click', ()=>{
      els.q.value = '';
      showSuggestions([]);
      els.results.innerHTML = '';
      els.q.focus();
    });

    // 按 Unicode 码点安全截断，避免切断汉字/emoji
    function truncateByChars(input, limit){
      const arr = Array.from(String(input || ''));
      if(arr.length <= (limit||0)) return arr.join('');
      return arr.slice(0, limit).join('') + '...';
    }

    // 如果 URL 上有 ?q=，自动搜索
    const urlQ = new URLSearchParams(location.search).get('q');
    if(urlQ){ els.q.value = urlQ; doSearch(urlQ); }
  </script>
</body>
</html>
